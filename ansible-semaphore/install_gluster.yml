---
- name: Install Docker and configure GlusterFS
  hosts: orange
  become: yes
  tasks:

    - name: Create GlusterFS brick folder
      file:
        path: /home/{{ ansible_user }}/Gluster/gv1
        state: directory
        mode: '0755'
    
    - name: Add GlusterFS GPG key
      ansible.builtin.get_url:
        url: https://download.gluster.org/pub/gluster/glusterfs/9/rsa.pub
        dest: /etc/apt/trusted.gpg.d/gluster.asc
        mode: '0644'
        force: true

    - name: Get DEBID
      ansible.builtin.shell: 
        cmd: grep 'VERSION_ID=' /etc/os-release | cut -d '=' -f 2 | tr -d '\"'
      register: debid

    - name: Get DEBVER
      ansible.builtin.shell: 
        cmd: grep 'VERSION=' /etc/os-release | grep -Eo '[a-z]+'
      register: debver
    
    - name: Get DEBARCH
      ansible.builtin.shell: 
        cmd: dpkg --print-architecture
      register: debarch

    - name:  Add GlusterFS repository
      apt_repository:
        repo:  'deb [signed-by=/etc/apt/trusted.gpg.d/gluster.asc] https://download.gluster.org/pub/gluster/glusterfs/LATEST/Debian/{{ debid.stdout }}/{{ debarch.stdout }}/apt {{ debver.stdout }} main'
        state: present
        update_cache: yes

    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install GlusterFS
      apt:
        name: glusterfs-server
        state: present

    - name: Enable service glusterd and ensure it is not masked
      ansible.builtin.systemd:
        name: glusterd
        enabled: true
        masked: no

    - name: Start service glusterd
      ansible.builtin.systemd_service:
        name: glusterd
        state: started

    - name: Add GlusterFS brick to fstab
      ansible.posix.mount:
        path: /home/{{ ansible_user }}/Gluster/gv1
        src: localhost:/gv1
        fstype: glusterfs
        opts: defaults
        state: present

    - name: Mount GlusterFS brick
      command: mount -a

    - name: Create Gluster volume
      gluster.gluster.gluster_volume:
        state: present
        name: gv1
        bricks: /home/{{ ansible_user }}/Gluster/gv1
        rebalance: yes
        cluster:
          - bitter-orange
          - blood-orange
          - navel-orange
          - sweet-orange
      run_once: true

    - name: Start gluster volume
      gluster.gluster.gluster_volume:
        state: started
        name: gv1